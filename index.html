<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Control de Pr茅stamos</title>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script> 
  <style>
    /* Estilos omitidos por brevedad, son los mismos de antes */
    :root{--bg:#0f1724;--card:#0b1220;--accent1:#6ee7b7;--accent2:#7c5cff;--glass: rgba(255,255,255,0.04);--muted: rgba(255,255,255,0.65);--success:#10b981;--danger:#ef4444;--soft-shadow: 0 6px 24px rgba(2,6,23,0.6);font-synthesis: none;}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,#071025 0%, #081225 60%); color:#e6eef8; -webkit-font-smoothing:antialiased; padding:20px}
    .app{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:360px 1fr;gap:20px;align-items:start}@media (max-width:980px){.app{grid-template-columns:1fr}}.sidebar{background:linear-gradient(180deg, rgba(124,92,255,0.12), rgba(110,231,183,0.06));padding:18px;border-radius:14px;box-shadow:var(--soft-shadow);backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.04)}.brand{display:flex;gap:12px;align-items:center}.logo{width:48px;height:48px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent2),var(--accent1));box-shadow:0 6px 18px rgba(124,92,255,0.12);font-weight:700}h1{font-size:18px;margin:0}p.lead{margin:6px 0 14px;color:var(--muted);font-size:13px}label{display:block;font-size:13px;color:var(--muted);margin-top:10px}input[type=text], input[type=number], input[type=password], select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:inherit}.row{display:flex;gap:10px}.row > *{flex:1}.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600}.btn.primary{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:#021024;box-shadow:0 10px 30px rgba(110,231,183,0.08);}.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}.actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}.clients{background:var(--card);padding:12px;border-radius:12px;box-shadow:var(--soft-shadow);border:1px solid rgba(255,255,255,0.03)}.client-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));transition:transform .18s ease, box-shadow .18s ease}.client-item:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(2,6,23,0.6)}.avatar{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;font-weight:700}.client-meta{flex:1}.client-meta b{display:block}.small{font-size:13px;color:var(--muted)}.main{min-height:480px}.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:var(--soft-shadow)}.grid-2{display:grid;grid-template-columns:1fr 360px;gap:16px}@media (max-width:980px){.grid-2{grid-template-columns:1fr}}.summary{display:flex;gap:12px;flex-wrap:wrap}.stat{flex:1;min-width:160px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}.stat strong{display:block;font-size:18px}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}th{text-align:center}.current-due td{background: rgba(239, 68, 68, 0.1);}.current-due td:first-child, .current-due td:nth-child(2) {color: var(--danger);}.logo{animation:floaty 6s ease-in-out infinite}.muted{color:var(--muted)}.center{display:grid;place-items:center}.pill{padding:6px 10px;border-radius:999px;background:var(--glass-2);font-weight:700}.danger{color:var(--danger)}.success{color:var(--success)}.error-msg{color:var(--danger); font-size:13px; margin-top:10px; font-weight:600;}.login-screen{display:grid; place-items:center; height:100vh; background:linear-gradient(180deg,#071025 0%, #081225 60%); color:#e6eef8; flex-direction:column; gap:20px;}.login-card{max-width:300px; padding:20px; border-radius:14px; background:var(--card); text-align:center;box-shadow:var(--soft-shadow);border:1px solid rgba(255,255,255,0.04);}
  </style>
</head>
<body>
  
  <div class="login-screen" id="loginScreen" style="display:grid;">
    <h2> Iniciar Sesi贸n</h2>
    <div class="login-card">
        <label>Usuario</label>
        <input id="loginUser" type="text" placeholder="Usuario" value="" />
        
        <label style="margin-top:15px;">Clave</label>
        <input id="loginPass" type="password" placeholder="Contrase帽a" value="" />

        <div id="loginError" class="error-msg" style="display:none;">Usuario o clave incorrecta.</div>
        
        <button id="loginBtn" class="btn primary" style="width:100%; margin-top:20px;">Acceder</button>
        
        <p class="small muted" style="margin-top:10px">Usuario: CesarPati | Clave: cesarpati12345</p>
        <div id="syncStatus" class="small" style="margin-top:10px; color:var(--accent1);">Esperando sincronizaci贸n...</div>
    </div>
  </div>

  <div class="app" id="mainApp" style="display:none; padding:20px;">

    <aside class="sidebar">
      <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="brand">
            <div class="logo">P%</div>
            <div>
              <h1>Control de Pr茅stamos</h1>
              <p class="lead" id="appLead">Tasa variable 路 Clave: XXXXX</p>
            </div>
          </div>
          <button id="logoutBtn" class="btn ghost" style="margin-left:10px;">Salir</button>
      </div>

      <div style="margin-top:12px">
        <label>Nombre del cliente</label>
        <input id="clientName" type="text" placeholder="Ej. Juan P茅rez" />

        <div class="row">
          <div>
            <label>Monto prestado (MXN)</label>
            <input id="clientAmount" type="number" min="0" step="0.01" value="1000" />
          </div>
          <div>
            <label>Tasa (%)</label>
            <input id="clientRate" type="number" min="1" max="20" step="1" value="7" />
          </div>
        </div>
        
        <div class="row">
            <div>
                <label>Plazo (meses)</label>
                <input id="clientMonths" type="number" min="1" step="1" value="6" />
            </div>
            <div>
                <label>Modo de amortizaci贸n</label>
                <select id="clientMode">
                  <option value="amortizacion">Amortizaci贸n (cuota fija)</option>
                  <option value="simple">Inter茅s simple</option>
                </select>
            </div>
        </div>

        <div class="actions">
          <button id="addClient" class="btn primary">Agregar cliente</button>
          <button id="clearAll" class="btn ghost">Eliminar todo</button>
          <button id="manualSync" class="btn ghost" style="background:var(--accent2); color:white; margin-top:10px;">Sincronizar a GitHub</button>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="clients card" id="clientsList">
          </div>
      </div>
    </aside>

    <main class="main">
      <div class="grid-2">
        <div class="card" id="detailCard">
          <div id="emptyState" class="center" style="padding:40px;flex-direction:column">
            <div class="muted">Selecciona un cliente o crea uno nuevo para ver su detalle</div>
          </div>

          <div id="clientDetail" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h2 id="detailName" style="margin:0"></h2>
                <div class="small muted" id="detailMeta"></div>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <div class="pill" id="detailRatePill">Tasa: 7% / mes</div>
                <button id="downloadClientCSV" class="btn ghost">Exportar EXCEL</button>
                <button id="deleteClient" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04)">Eliminar</button>
              </div>
            </div>

            <div class="summary" style="margin-top:12px">
              <div class="stat">
                <small class="muted">Saldo inicial</small>
                <strong id="statPrincipal">$0.00</strong>
              </div>
              <div class="stat">
                <small class="muted">Total pagado</small>
                <strong id="statPaid">$0.00</strong>
              </div>
              <div class="stat">
                <small class="muted">Saldo pendiente</small>
                <strong id="statDue">$0.00</strong>
              </div>
            </div>

            <div style="margin-top:12px">
              <h3 style="margin:0 0 8px 0">Registrar pago</h3>
              <div class="row">
                <input id="payAmount" type="number" placeholder="Monto" />
                <input id="payNote" type="text" placeholder="Notas (ej. mes 1)" />
              </div>
              <div class="actions" style="margin-top:8px">
                <button id="addPayment" class="btn primary">A帽adir pago</button>
                <button id="applyAuto" class="btn ghost">Aplicar al siguiente</button>
                <button id="addNoPayment" class="btn ghost" style="background:var(--danger); color:white">Marcar No Pago</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <h3 style="margin:0 0 8px 0">Calendario / Pagos</h3>
              <div id="scheduleWrap" style="max-height:320px;overflow:auto"></div>
            </div>

            <div style="margin-top:10px">
              <h3 style="margin:0 0 8px 0">Historial de pagos</h3>
              <div id="paymentsWrap" style="max-height:220px;overflow:auto"></div>
            </div>

          </div>
        </div>

        <aside class="card">
          <h3 style="margin-top:0">Resumen global</h3>
          <div class="small muted">Total de clientes: <span id="globalCount">0</span></div>
          <div style="margin-top:12px">
            <table>
              <thead><tr><th>Cliente</th><th>Debe</th><th>Pagado</th></tr></thead>
              <tbody id="globalTable"></tbody>
            </table>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <script>
    
    // --- CREDENCIALES FIJAS ---
    const VALID_USER = 'CesarPati';
    const VALID_PASS = 'cesarpati12345';
    
    // --- CONFIGURACIN DE GITHUB GIST (DEBES MODIFICAR ESTO) ---
    // 锔 ADVERTENCIA: PEGA AQU EL TOKEN Y EL ID DEL GIST.
    const GITHUB_TOKEN = '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'; // <-- Reemplaza
    const GIST_ID = 'c2d870a040cd9f47750cd6f6bc7ec296'; // <-- Reemplaza (Ej: c5f874ab0d4567c293623315a67890f5)
    const GIST_FILENAME = 'app_data_clientes.json'; // Nombre del archivo dentro del Gist

    // VARIABLES GLOBALES
    let clientsDataCache = [];
    let storageKey = 'prestamos_clients_local_cache'; 
    
    // ---------- Constantes y utilidades ----------
    const $ = id => document.getElementById(id);

    function money(n){return Number(n).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2})}
    function uid(){return 'c_'+Math.random().toString(36).slice(2,9)}

    // ---------- Sincronizaci贸n con GIST ----------
    
    // 1. CARGA LOS DATOS DEL GIST
    async function loadDataFromGitHub(){
        $('syncStatus').textContent = 'Descargando datos desde Gist...';
        
        try {
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: Revisa si el GIST ID es correcto o el token tiene permiso 'gist'.`);
            }

            const data = await response.json();
            
            if (!data.files || !data.files[GIST_FILENAME]) {
                throw new Error(`Archivo ${GIST_FILENAME} no encontrado dentro del Gist.`);
            }
            
            const content = data.files[GIST_FILENAME].content;
            clientsDataCache = JSON.parse(content);
            
            $('syncStatus').textContent = `Sincronizaci贸n exitosa. Clientes cargados: ${clientsDataCache.length}`;
            return true;

        } catch (error) {
            console.error("Error en la carga de Gist:", error);
            $('syncStatus').textContent = `ERROR DE CARGA: ${error.message}`;
            clientsDataCache = JSON.parse(localStorage.getItem(storageKey) || '[]');
            alert("锔 隆Error de sincronizaci贸n con Gist! Se cargaron datos locales.");
            return false;
        }
    }

    // 2. GUARDA LOS DATOS AL GIST
    async function syncDataToGitHub(){
        $('syncStatus').textContent = 'Subiendo datos a Gist...';
        
        try {
            const content = JSON.stringify(clientsDataCache);
            
            const payload = {
                description: `Actualizaci贸n de clientes (${new Date().toLocaleString()})`,
                files: {
                    [GIST_FILENAME]: {
                        content: content
                    }
                }
            };

            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH', // Usamos PATCH para actualizar
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Error al subir: ${response.statusText}`);
            }

            $('syncStatus').textContent = '隆Datos sincronizados con 茅xito!';
            return true;

        } catch (error) {
            console.error("Error en la sincronizaci贸n a Gist:", error);
            $('syncStatus').textContent = `ERROR AL SUBIR DATOS.`;
            return false;
        }
    }


    // --- FUNCIONES DE CLCULO ---
    function calcAmortizacion(P, n, rate){
      const r = rate / 100;
      const cuota = (P * r) / (1 - Math.pow(1 + r, -n));
      let saldo = P;
      const schedule = [];
      let interesTotal = 0;
      for(let i=1;i<=n;i++){
        const interes = saldo * r;
        const abono = cuota - interes;
        saldo = Math.max(0, saldo - abono);
        schedule.push({mes:i, cuota: Number(cuota.toFixed(2)), interes: Number(interes.toFixed(2)), abono: Number(abono.toFixed(2)), saldo: Number(saldo.toFixed(2))}); 
        interesTotal += interes;
      }
      return {cuota: Number(cuota.toFixed(2)), interesTotal: Number(interesTotal.toFixed(2)), schedule};
    }

    function calcSimple(P,n, rate){
      const r = rate / 100;
      const interesMensual = P * r;
      const interesTotal = interesMensual * n;
      const pagoTotal = P + interesTotal;
      return {interesMensual: Number(interesMensual.toFixed(2)), interesTotal: Number(interesTotal.toFixed(2)), pagoTotal: Number(pagoTotal.toFixed(2))}
    }

    // --- MANEJO DE CLIENTES (Usa el cach茅) ---
    function loadClients(){
      return clientsDataCache; 
    }
    
    function saveClients(clients){
        clientsDataCache = clients;
        localStorage.setItem(storageKey, JSON.stringify(clients));
        syncDataToGitHub(); // Sincronizaci贸n autom谩tica
    }

    // --- Funciones de Renderizado ---
    function renderClients(){
      const list = $('clientsList'); list.innerHTML='';
      const clients = loadClients();
      clients.forEach(c=>{
        const dueAmount = getClientDue(c);
        const dueClass = dueAmount > 0 ? 'danger' : 'success';
        const div = document.createElement('div'); div.className='client-item'; div.dataset.id = c.id;
        div.innerHTML = `
          <div class="avatar">${c.name.split(' ').map(s=>s[0]).slice(0,2).join('')}</div>
          <div class="client-meta">
            <b>${c.name}</b>
            <div class="small muted">Prestado: $${money(c.principal)} 路 Meses: ${c.months} 路 Tasa: ${c.rate}%</div>
          </div>
          <div style="text-align:right">
            <div class="small muted">Adeuda</div>
            <div class="${dueClass}"><strong>$${money(dueAmount)}</strong></div>
          </div>
        `;
        div.addEventListener('click', ()=>selectClient(c.id));
        list.appendChild(div);
      });
      $('globalCount').textContent = clients.length;
      renderGlobalTable();
    }

    function renderGlobalTable(){
      const clients = loadClients();
      const tbody = $('globalTable'); tbody.innerHTML='';
      clients.forEach(c=>{
        const tr = document.createElement('tr');
        const dueAmount = getClientDue(c);
        const dueClass = dueAmount > 0 ? 'danger' : '';
        tr.innerHTML = `<td>${c.name}</td><td class="${dueClass}">$${money(dueAmount)}</td><td>$${money(getClientPaidTotal(c))}</td>`;
        tbody.appendChild(tr);
      });
    }

    let activeClientId = null;
    function selectClient(id){
      const clients = loadClients();
      const c = clients.find(x=>x.id===id);
      if(!c) return;
      activeClientId = id;
      $('emptyState').style.display='none';
      $('clientDetail').style.display='block';
      $('detailName').textContent = c.name;
      $('detailMeta').textContent = `Prestado $${money(c.principal)} 路 ${c.months} meses 路 Tasa: ${c.rate}% 路 ${c.mode==='amortizacion'?'Amortizaci贸n':'Inter茅s simple'}`;
      $('detailRatePill').textContent = `Tasa: ${c.rate}% / mes`;
      $('statPrincipal').textContent = '$'+money(c.principal);
      $('statPaid').textContent = '$'+money(getClientPaidTotal(c));
      $('statDue').textContent = '$'+money(getClientDue(c));
      renderSchedule(c);
      renderPayments(c);
    }

    function getClientPaidTotal(c){
      return (c.payments||[]).reduce((s,p)=>s + Number(p.amount||0),0)
    }

    function getClientDue(c){
      if(c.mode==='simple'){
        const summary = calcSimple(c.principal, c.months, c.rate);
        const paid = getClientPaidTotal(c);
        return Math.max(0, summary.pagoTotal - paid);
      } else {
        const summary = calcAmortizacion(c.principal, c.months, c.rate);
        const total = summary.cuota * c.months;
        const paid = getClientPaidTotal(c);
        return Math.max(0, total - paid);
      }
    }

    function renderSchedule(c){
      const wrap = $('scheduleWrap'); wrap.innerHTML='';
      if(c.mode==='simple'){
        const s = calcSimple(c.principal, c.months, c.rate);
        wrap.innerHTML = `<div class="small muted">Inter茅s mensual: $${money(s.interesMensual)} 路 Inter茅s total: $${money(s.interesTotal)} 路 Total a pagar: $${money(s.pagoTotal)}</div>`;
        return;
      }
      const amort = calcAmortizacion(c.principal, c.months, c.rate);
      let html = '<table><thead><tr><th>Mes</th><th>Cuota</th><th>Inter茅s</th><th>Abono</th><th>Estado</th></tr></thead><tbody>';
      
      let paidAmount = getClientPaidTotal(c);
      let isFirstPending = true;

      amort.schedule.forEach(row=>{
        let estado = 'Pendiente';
        let rowClass = ''; 
        
        if(paidAmount >= row.cuota){
          estado='Pagado'; 
          paidAmount -= row.cuota;
        }
        else { 
          if(paidAmount > 0){
            estado = 'Parcial'; 
            paidAmount = 0;
          }

          if(isFirstPending) { 
            rowClass = 'current-due'; 
            isFirstPending = false; 
          }
        }

        html += `<tr class="${rowClass}"><td style="text-align:center"><strong>${row.mes}</strong></td><td><strong>$${money(row.cuota)}</strong></td><td>$${money(row.interes)}</td><td>$${money(row.abono)}</td><td style="text-align:center">${estado}</td></tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    function renderPayments(c){
      const wrap = $('paymentsWrap'); wrap.innerHTML='';
      const payments = (c.payments||[]).slice().reverse();
      if(payments.length===0){wrap.innerHTML='<div class="muted small">A煤n no hay pagos registrados.</div>';return}
      let html = '<table><thead><tr><th>Fecha</th><th>Nota</th><th style="text-align:right">Monto</th><th></th></tr></thead><tbody>';
      payments.forEach(p=>{
        const noteClass = (p.note === 'MES NO PAGADO') ? 'danger' : '';
        html += `<tr><td>${p.date}</td><td class="${noteClass}">${p.note||''}</td><td style="text-align:right">$${money(p.amount)}</td><td style="text-align:right"><button class="btn ghost" data-payid="${p.id}">Eliminar</button></td></tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
      wrap.querySelectorAll('button[data-payid]').forEach(btn=>btn.addEventListener('click', ()=>{
        const payId = btn.dataset.payid; deletePayment(activeClientId, payId);
      }));
    }

    function addPaymentToClient(clientId, amount, note){
      const clients = loadClients();
      const c = clients.find(x=>x.id===clientId); if(!c) return;
      c.payments = c.payments || [];
      c.payments.push({id: 'p_'+Math.random().toString(36).slice(2,9), amount: Number(amount), note: note||'', date: new Date().toLocaleString()});
      saveClients(clients); selectClient(clientId); renderClients();
    }

    function deletePayment(clientId, payId){
      const clients = loadClients(); const c = clients.find(x=>x.id===clientId); if(!c) return;
      c.payments = (c.payments||[]).filter(p=>p.id!==payId);
      saveClients(clients); selectClient(clientId); renderClients();
    }

    // --- Actions UI (Gatillan saveClients) ---
    $('addClient').addEventListener('click', ()=>{
      const name = $('clientName').value.trim();
      const principal = Number($('clientAmount').value) || 0;
      const rate = Number($('clientRate').value) || 7; 
      const months = parseInt($('clientMonths').value) || 1;
      const mode = $('clientMode').value;
      if(!name || principal<=0 || months<=0 || rate<1 || rate>20){alert('Llena nombre, monto, plazo y tasa v谩lidos (1-20%).');return}
      const clients = loadClients();
      const newClient = {id: uid(), name, principal, rate, months, mode, payments: []};
      clients.push(newClient); saveClients(clients); renderClients();
      $('clientName').value=''; $('clientAmount').value='1000'; $('clientMonths').value='6'; $('clientRate').value='7';
    });

    $('clearAll').addEventListener('click', ()=>{
      if(!confirm('Eliminar todos los clientes y datos? Se intentar谩 eliminar el archivo de Gist.')) return;
      clientsDataCache = []; // Limpia el cach茅
      saveClients([]); // Sincroniza cach茅 vac铆o
      renderClients();
      $('emptyState').style.display='grid'; $('clientDetail').style.display='none'; activeClientId=null; renderGlobalTable();
    });

    $('addPayment').addEventListener('click', ()=>{
      if(!activeClientId){alert('Selecciona un cliente primero.');return}
      const amt = Number($('payAmount').value) || 0; const note = $('payNote').value.trim();
      if(amt<=0){alert('Ingresa un monto v谩lido.');return}
      addPaymentToClient(activeClientId, amt, note);
      $('payAmount').value=''; $('payNote').value='';
    });

    $('addNoPayment').addEventListener('click', ()=>{
      if(!activeClientId){alert('Selecciona un cliente primero.');return}
      if(!confirm('驴Confirmas que el cliente NO realiz贸 el pago de este mes? Se registrar谩 un pago de $0.00 con la nota "MES NO PAGADO".')) return;
      addPaymentToClient(activeClientId, 0, 'MES NO PAGADO');
      $('payAmount').value=''; $('payNote').value='';
    });

    $('applyAuto').addEventListener('click', ()=>{
      if(!activeClientId){alert('Selecciona un cliente primero.');return}
      const clients = loadClients(); const c = clients.find(x=>x.id===activeClientId); if(!c) return;
      let suggested = 0;
      if(c.mode==='simple'){ suggested = calcSimple(c.principal,c.months, c.rate).interesMensual; }
      else{ suggested = calcAmortizacion(c.principal,c.months, c.rate).cuota; }
      if(!confirm(`Registrar pago autom谩tico de $${money(suggested)}?`)) return;
      addPaymentToClient(activeClientId, suggested, 'Pago autom谩tico (cuota)');
    });

    $('deleteClient').addEventListener('click', ()=>{
      if(!activeClientId) return; if(!confirm('Eliminar este cliente?')) return;
      let clients = loadClients(); clients = clients.filter(x=>x.id!==activeClientId); saveClients(clients); renderClients();
      activeClientId = null; $('emptyState').style.display='grid'; $('clientDetail').style.display='none';
    });
    
    // Sincronizaci贸n manual
    $('manualSync').addEventListener('click', syncDataToGitHub);

    // ... (funci贸n downloadClientCSV se mantiene igual)
    
    // ---------- LGICA DE LOGIN Y LOGOUT (MODIFICADA PARA SYNC) ----------
    
    async function startApp(user){
        
        document.getElementById('loginScreen').style.display = 'grid';
        document.getElementById('mainApp').style.display = 'none';
        
        // Carga los datos de Gist ANTES de iniciar la app
        const syncSuccess = await loadDataFromGitHub();

        if (syncSuccess) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'grid'; 
            
            document.getElementById('appLead').textContent = `Tasa variable 路 Usuario: ${user} 路 Sincronizado`;

            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
            
            renderClients();
            (function autoSelectFirst(){const clients=loadClients(); if(clients.length>0){selectClient(clients[0].id);}})();
            
            window.addEventListener('beforeunload', syncDataToGitHub);

        } else {
             document.getElementById('loginScreen').style.display = 'grid';
        }
    }
    
    function logout(){
        window.removeEventListener('beforeunload', syncDataToGitHub);
        
        syncDataToGitHub();
        
        activeClientId = null;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'grid';
        document.getElementById('loginError').style.display = 'none';
        
        $('syncStatus').textContent = 'Esperando sincronizaci贸n...';
    }

    // MANEJADOR DEL BOTN DE LOGIN
    document.getElementById('loginBtn').addEventListener('click', ()=>{
        const user = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value.trim();

        if (user === VALID_USER && pass === VALID_PASS) {
            document.getElementById('loginError').style.display = 'none';
            startApp(user);
        } else {
            document.getElementById('loginError').textContent = 'Usuario o clave incorrecta.';
            document.getElementById('loginError').style.display = 'block';
        }
    });

    // MANEJADOR DEL BOTN DE LOGOUT
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
  </script>
</body>
</html>

